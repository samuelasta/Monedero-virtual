<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonederoApp - Programa de Puntos</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2575fc;
            --secondary-color: #6a11cb;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: white;
            position: fixed;
            padding-top: 1rem;
            z-index: 100;
        }
        @media (max-width: 767.98px) {
            .sidebar {
                position: static;
                min-height: auto;
            }
            .content-wrapper {
                margin-left: 0 !important;
            }
        }
        .content-wrapper {
            margin-left: 16.66%;
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(5px);
        }
        .sidebar .nav-link i {
            margin-right: 0.5rem;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: none;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-weight: 600;
        }
        .nav-pills .nav-link.active {
            background-color: var(--primary-color);
        }
        .nav-pills .nav-link {
            color: var(--primary-color);
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(37, 117, 252, 0.25);
        }
        .points-card {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }
        .points-card .card-body {
            padding: 2rem;
        }
        .badge-rank {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
        }
        .badge-bronze {
            background-color: #cd7f32;
        }
        .badge-silver {
            background-color: #c0c0c0;
        }
        .badge-gold {
            background-color: #ffd700;
            color: #212529;
        }
        .badge-platinum {
            background-color: #e5e4e2;
            color: #212529;
        }
        .points-item {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .points-item:hover {
            background-color: #f8f9fa;
        }
        .points-earned {
            border-left-color: #198754;
        }
        .points-redeemed {
            border-left-color: #dc3545;
        }
        .points-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }
        .points-earned-icon {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
        }
        .points-redeemed-icon {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        .points-positive {
            color: #198754;
            font-weight: 500;
        }
        .points-negative {
            color: #dc3545;
            font-weight: 500;
        }
        .reward-card {
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
        }
        .reward-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .reward-card .card-img-top {
            height: 160px;
            object-fit: cover;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }
        .reward-points {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.8rem;
        }
        .rank-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        .rank-card.active {
            transform: scale(1.05);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .rank-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
        }
        .rank-bronze {
            background-color: rgba(205, 127, 50, 0.2);
            color: #cd7f32;
        }
        .rank-silver {
            background-color: rgba(192, 192, 192, 0.2);
            color: #c0c0c0;
        }
        .rank-gold {
            background-color: rgba(255, 215, 0, 0.2);
            color: #ffd700;
        }
        .rank-platinum {
            background-color: rgba(229, 228, 226, 0.2);
            color: #e5e4e2;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
        }
        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky">
                <div class="text-center mb-4">
                    <h3 class="fw-bold">MonederoApp</h3>
                    <i class="bi bi-wallet2 fs-1"></i>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/wallets">
                            <i class="bi bi-wallet"></i> Mis Monederos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/transactions">
                            <i class="bi bi-arrow-left-right"></i> Transacciones
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/scheduled">
                            <i class="bi bi-calendar-check"></i> Programadas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/points">
                            <i class="bi bi-star"></i> Puntos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analytics">
                            <i class="bi bi-graph-up"></i> Análisis
                        </a>
                    </li>
                    <li class="nav-item mt-5">
                        <a class="nav-link" href="/profile">
                            <i class="bi bi-person-circle"></i> Mi Perfil
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">
                            <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <main class="col-md-10 col-lg-10 content-wrapper px-md-4 py-4">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light bg-white mb-4 shadow-sm rounded-3">
                <div class="container-fluid">
                    <button class="navbar-toggler d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target=".sidebar">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0">Programa de Puntos</h5>
                    </div>
                    <div class="user-info">
                        <div class="user-avatar" th:if="${cliente != null}" th:text="${#strings.substring(cliente.nombre,0,1).toUpperCase()}">U</div>
                        <div class="d-none d-sm-block">
                            <span class="fw-bold" th:if="${cliente != null}" th:text="${cliente.nombre}">Usuario</span>
                            <span class="badge ms-1" th:if="${cliente != null}" th:classappend="'badge-' + ${#strings.toLowerCase(cliente.rango)}" th:text="${cliente.rango}">RANGO</span>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Points Content -->
            <ul class="nav nav-pills mb-4" id="pointsTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" type="button" role="tab" aria-controls="summary" aria-selected="true">Resumen</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">Historial</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="redeem-tab" data-bs-toggle="tab" data-bs-target="#redeem" type="button" role="tab" aria-controls="redeem" aria-selected="false">Canjear Puntos</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ranks-tab" data-bs-toggle="tab" data-bs-target="#ranks" type="button" role="tab" aria-controls="ranks" aria-selected="false">Rangos</button>
                </li>
            </ul>

            <div class="tab-content" id="pointsTabsContent">
                <!-- Summary Tab -->
                <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card points-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-4">
                                        <div>
                                            <h6 class="text-white-50">Puntos Disponibles</h6>
                                            <h2 class="display-4 fw-bold" th:text="${puntos != null ? puntos.puntosAcumulados : 0}">0</h2>
                                        </div>
                                        <span class="badge badge-rank" th:if="${cliente != null}" th:classappend="'badge-' + ${#strings.toLowerCase(cliente.rango)}" th:text="${cliente.rango}">BRONCE</span>
                                    </div>
                                    <div class="mb-4" th:if="${rangosInfo != null}">
                                        <h6 class="text-white-50">Progreso al siguiente rango</h6>
                                        <div class="progress bg-white bg-opacity-25">
                                            <div class="progress-bar bg-warning" role="progressbar" th:style="'width: ' + ${rangosInfo.porcentajeAvance} + '%'" th:aria-valuenow="${rangosInfo.porcentajeAvance}" aria-valuemin="0" aria-valuemax="100" th:text="${#numbers.formatDecimal(rangosInfo.porcentajeAvance, 0, 0)} + '%'">0%</div>
                                        </div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <small class="text-white-50" th:text="${puntos != null ? puntos.puntosAcumulados : 0} + ' pts'">0 pts</small>
                                            <small class="text-white-50" th:if="${rangosInfo.puntosNecesarios > 0}" th:text="${puntos != null ? puntos.puntosAcumulados + rangosInfo.puntosNecesarios : 0} + ' pts'">0 pts</small>
                                            <small class="text-white-50" th:unless="${rangosInfo.puntosNecesarios > 0}">Rango máximo</small>
                                        </div>
                                        <div class="text-center mt-2">
                                            <small class="text-white" th:if="${rangosInfo.puntosNecesarios > 0}" th:text="${rangosInfo.puntosNecesarios} + ' puntos más para alcanzar el rango ' + ${rangosInfo.siguienteRango}">0 puntos más para alcanzar el rango siguiente</small>
                                            <small class="text-white" th:unless="${rangosInfo.puntosNecesarios > 0}">¡Has alcanzado el rango máximo!</small>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex flex-column">
                                                <span class="text-white-50">Puntos Ganados</span>
                                                <span class="fs-5" id="pointsEarned">0 pts</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex flex-column">
                                                <span class="text-white-50">Puntos Canjeados</span>
                                                <span class="fs-5" id="pointsRedeemed">0 pts</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <i class="bi bi-gift"></i> Beneficios Disponibles
                                </div>
                                <div class="card-body">
                                    <div class="list-group">
                                        <div th:if="${beneficiosDisponibles == null || beneficiosDisponibles.isEmpty()}" class="text-center py-4">
                                            <i class="bi bi-gift fs-1 text-muted"></i>
                                            <p class="mt-3 text-muted">No hay beneficios disponibles en este momento.</p>
                                        </div>
                                        <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                           th:each="beneficio : ${beneficiosDisponibles}" data-bs-toggle="modal" data-bs-target="#redeemModal">
                                            <div>
                                                <h6 class="mb-1" th:text="${beneficio.nombre}">Beneficio</h6>
                                                <p class="mb-1 text-muted small" th:text="${beneficio.descripcion}">Descripción del beneficio</p>
                                            </div>
                                            <span class="badge bg-primary rounded-pill" th:text="${beneficio.costePuntos} + ' pts'">0 pts</span>
                                        </a>
                                    </div>
                                    <div class="d-grid gap-2 mt-3">
                                        <button class="btn btn-primary" onclick="document.getElementById('redeem-tab').click()">
                                            Ver Todos los Beneficios
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi bi-clock-history"></i> Actividad Reciente
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="document.getElementById('history-tab').click()">
                                Ver Todo el Historial
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="recentPoints">
                                <!-- Las transacciones de puntos recientes se cargarán dinámicamente -->
                                <div class="text-center py-4" id="noRecentActivity">
                                    <i class="bi bi-activity fs-1 text-muted"></i>
                                    <p class="mt-3 text-muted">No hay actividad reciente de puntos.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <i class="bi bi-clock-history"></i> Historial de Puntos
                                </div>
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="pointsSearch" placeholder="Buscar...">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <select class="form-select" id="typeFilter">
                                        <option value="">Todos los Tipos</option>
                                        <option value="earned">Puntos Ganados</option>
                                        <option value="redeemed">Puntos Canjeados</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <input type="date" class="form-control" id="dateFromFilter" placeholder="Desde">
                                </div>
                                <div class="col-md-4">
                                    <input type="date" class="form-control" id="dateToFilter" placeholder="Hasta">
                                </div>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover" id="pointsHistoryTable">
                                    <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Tipo</th>
                                        <th>Descripción</th>
                                        <th>Puntos</th>
                                    </tr>
                                    </thead>
                                    <tbody id="pointsHistoryBody">
                                    <!-- Las transacciones de puntos se cargarán dinámicamente -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Redeem Tab -->
                <div class="tab-pane fade" id="redeem" role="tabpanel" aria-labelledby="redeem-tab">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-gift"></i> Canjear Puntos
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <i class="bi bi-star-fill fs-1 text-warning"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Puntos Disponibles</h6>
                                            <h3 class="mb-0" th:text="${puntos != null ? puntos.puntosAcumulados : 0} + ' pts'">1,250 pts</h3>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                                        <input type="text" class="form-control" id="rewardSearch" placeholder="Buscar beneficios...">
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-12">
                                    <h5>Beneficios Disponibles</h5>
                                    <hr>
                                </div>
                            </div>

                            <div class="row" id="rewardsContainer">
                                <!-- Los beneficios se cargarán dinámicamente -->
                                <div class="col-12 text-center py-4" id="noRewardsMessage">
                                    <i class="bi bi-emoji-frown fs-1 text-muted"></i>
                                    <p class="mt-3 text-muted">No hay beneficios disponibles en este momento.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ranks Tab -->
                <div class="tab-pane fade" id="ranks" role="tabpanel" aria-labelledby="ranks-tab">
                    <div class="card">
                        <div class="card-header">
                            <i class="bi bi-trophy"></i> Sistema de Rangos
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-12">
                                    <p>Nuestro sistema de rangos te premia por tu actividad en la plataforma. A medida que acumulas puntos, vas subiendo de rango y desbloqueando beneficios exclusivos.</p>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-3 mb-4">
                                    <div class="rank-card" th:classappend="${cliente != null && cliente.rango == 'BRONCE' ? 'active' : ''}">
                                        <div class="rank-icon rank-bronze">
                                            <i class="bi bi-trophy"></i>
                                        </div>
                                        <h5>Bronce</h5>
                                        <p class="text-muted">0 - 999 puntos</p>
                                        <hr>
                                        <ul class="list-unstyled text-start">
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Acceso básico</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Soporte estándar</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="rank-card" th:classappend="${cliente != null && cliente.rango == 'PLATA' ? 'active' : ''}">
                                        <div class="rank-icon rank-silver">
                                            <i class="bi bi-trophy"></i>
                                        </div>
                                        <h5>Plata</h5>
                                        <p class="text-muted">1,000 - 4,999 puntos</p>
                                        <hr>
                                        <ul class="list-unstyled text-start">
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Todo de Bronce</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> 5% descuento en comisiones</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Cashback 1%</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="rank-card" th:classappend="${cliente != null && cliente.rango == 'ORO' ? 'active' : ''}">
                                        <div class="rank-icon rank-gold">
                                            <i class="bi bi-trophy"></i>
                                        </div>
                                        <h5>Oro</h5>
                                        <p class="text-muted">5,000 - 14,999 puntos</p>
                                        <hr>
                                        <ul class="list-unstyled text-start">
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Todo de Plata</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> 10% descuento en comisiones</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Cashback 2%</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Soporte prioritario</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-4">
                                    <div class="rank-card" th:classappend="${cliente != null && cliente.rango == 'PLATINO' ? 'active' : ''}">
                                        <div class="rank-icon rank-platinum">
                                            <i class="bi bi-trophy"></i>
                                        </div>
                                        <h5>Platino</h5>
                                        <p class="text-muted">15,000+ puntos</p>
                                        <hr>
                                        <ul class="list-unstyled text-start">
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Todo de Oro</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> 20% descuento en comisiones</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Cashback 3%</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Soporte VIP</li>
                                            <li><i class="bi bi-check-circle-fill text-success me-2"></i> Beneficios exclusivos</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="alert alert-info">
                                        <h5><i class="bi bi-info-circle-fill"></i> ¿Cómo ganar puntos?</h5>
                                        <ul>
                                            <li><strong>Depósitos:</strong> Gana 1 punto por cada $100 depositados (1% del monto).</li>
                                            <li><strong>Transferencias:</strong> Gana 0.5 puntos por cada $100 transferidos (0.5% del monto).</li>
                                            <li><strong>Invitar amigos:</strong> Gana 100 puntos por cada amigo que se registre usando tu código.</li>
                                            <li><strong>Fidelidad:</strong> Gana 50 puntos cada mes por mantener un saldo promedio superior a $1,000,000.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Redeem Modal -->
<div class="modal fade" id="redeemModal" tabindex="-1" aria-labelledby="redeemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="redeemModalLabel">Canjear Beneficio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="bi bi-gift fs-1 text-primary"></i>
                </div>
                <h5 class="modal-title text-center mb-4" id="benefitName">Descuento en comisiones</h5>

                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Detalles del Beneficio</h6>
                        <p id="benefitDescription">Obtén un 50% de descuento en comisiones por transferencias durante 1 mes</p>
                        <div class="d-flex justify-content-between">
                            <span>Costo:</span>
                            <span class="fw-bold" id="benefitCost">500 pts</span>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-subtitle mb-2 text-muted">Tus Puntos</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Puntos Disponibles:</span>
                            <span class="fw-bold" id="availablePoints" th:text="${puntos != null ? puntos.puntosAcumulados : 0} + ' pts'">1,250 pts</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <span>Puntos Restantes Después del Canje:</span>
                            <span class="fw-bold" id="remainingPoints">750 pts</span>
                        </div>
                    </div>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmRedeem" required>
                    <label class="form-check-label" for="confirmRedeem">
                        Confirmo que deseo canjear mis puntos por este beneficio
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="redeemButton" disabled>Canjear Puntos</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS Bundle with Popper -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- Points.js -->
<script th:inline="javascript">
    // Obtener los datos del modelo de Thymeleaf
    const cliente = /*[[${cliente}]]*/ {
        nombre: 'Usuario Demo',
        email: 'demo@example.com',
        rango: 'PLATA'
    };

    const puntos = /*[[${puntos}]]*/ {
        puntosAcumulados: 1250
    };

    const rangosInfo = /*[[${rangosInfo}]]*/ {
        rangoActual: 'PLATA',
        siguienteRango: 'ORO',
        puntosNecesarios: 750,
        porcentajeAvance: 65
    };

    let beneficiosDisponibles = /*[[${beneficiosDisponibles}]]*/ [];

    // Función para mostrar overlay de carga
    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }

    // Función para ocultar overlay de carga
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }

    // Función para formatear fecha
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('es-CO', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // Función que carga los datos reales del usuario actual
    function loadUserData() {
        showLoading();

        // Aquí usamos los datos del modelo de Thymeleaf
        // Si no hay datos del cliente, los puntos se mantienen en 0
        const puntosDisponibles = puntos ? puntos.puntosAcumulados : 0;

        // Obtener transacciones de puntos del historial del usuario
        // Verificamos si hay un historial de puntos del usuario
        let historialPuntos = [];

        // Si puntos no existe o no tiene historial, mostramos la interfaz sin transacciones
        if (!puntos || !puntos.historialPuntos) {
            // No hay historial de puntos para este usuario
            updatePointsUI([], 0, 0);
            hideLoading();
            return;
        }

        // Si estamos en un entorno de prueba y no tenemos datos reales, generaremos algunos datos para mostrar
        // En producción, esta sección usaría solo los datos reales del usuario
        if (typeof historialPuntosData !== 'undefined' && historialPuntosData) {
            // Usar datos reales de las transacciones si están disponibles
            historialPuntos = historialPuntosData;
        } else {
            // Crear un historial mínimo basado en los puntos actuales del usuario
            // Solo para demostración, en producción esto vendría del backend
            const ahora = new Date();

            if (puntosDisponibles === 0) {
                // Si el usuario tiene 0 puntos, mostrar un historial vacío
                historialPuntos = [];
            } else {
                // Crear transacciones basadas en el rango actual del usuario
                const rangoActual = cliente ? cliente.rango : "BRONCE";

                // Fecha para la primera transacción (simulación)
                const fecha1 = new Date(ahora);
                fecha1.setDate(fecha1.getDate() - 12);

                // Fecha para la segunda transacción (simulación)
                const fecha2 = new Date(ahora);
                fecha2.setDate(fecha2.getDate() - 5);

                // Fecha para la tercera transacción (simulación)
                const fecha3 = new Date(ahora);
                fecha3.setDate(fecha3.getDate() - 1);

                if (rangoActual === "BRONCE") {
                    // El usuario es nuevo, probablemente solo tiene algunas transacciones
                    historialPuntos = [
                        {
                            id: "1",
                            tipo: "CANJE",
                            cantidad: -142,
                            fecha: fecha1.toISOString(),
                            motivo: "Canje de Descuento en comisiones"
                        },
                        {
                            id: "2",
                            tipo: "ACUMULACION",
                            cantidad: -185, // Esto parece un error en tus datos, debería ser positivo
                            fecha: fecha2.toISOString(),
                            motivo: "Depósito en efectivo"
                        },
                        {
                            id: "3",
                            tipo: "CANJE",
                            cantidad: -193,
                            fecha: fecha3.toISOString(),
                            motivo: "Canje de Tarjeta de regalo"
                        }
                    ];
                } else {
                    // Usuario con más antigüedad, probablemente tiene más transacciones
                    historialPuntos = [
                        {
                            id: "1",
                            tipo: "ACUMULACION",
                            cantidad: 150,
                            fecha: fecha1.toISOString(),
                            motivo: "Depósito en efectivo"
                        },
                        {
                            id: "2",
                            tipo: "ACUMULACION",
                            cantidad: 100,
                            fecha: fecha2.toISOString(),
                            motivo: "Transferencia realizada"
                        },
                        {
                            id: "3",
                            tipo: "CANJE",
                            cantidad: -200,
                            fecha: fecha3.toISOString(),
                            motivo: "Canje de Descuento en comisiones"
                        }
                    ];
                }
            }
        }

        // Calcular puntos ganados y canjeados según el historial
        const puntosGanados = historialPuntos
            .filter(tx => tx.tipo === "ACUMULACION")
            .reduce((sum, tx) => sum + (tx.cantidad > 0 ? tx.cantidad : 0), 0);

        const puntosCanjeados = historialPuntos
            .filter(tx => tx.tipo === "CANJE" || (tx.tipo === "ACUMULACION" && tx.cantidad < 0))
            .reduce((sum, tx) => sum + Math.abs(tx.cantidad), 0);

        // Actualizar la UI con los datos reales del usuario
        updatePointsUI(historialPuntos, puntosGanados, puntosCanjeados);

        hideLoading();
    }

    // Función para actualizar la UI con datos de puntos
    function updatePointsUI(historialPuntos, puntosGanados, puntosCanjeados) {
        // Actualizar puntos ganados y canjeados en el resumen
        document.getElementById('pointsEarned').textContent = puntosGanados + ' pts';
        document.getElementById('pointsRedeemed').textContent = puntosCanjeados + ' pts';

        // Actualizar actividad reciente en el resumen
        const recentPoints = document.getElementById('recentPoints');
        const noRecentActivity = document.getElementById('noRecentActivity');

        if (historialPuntos && historialPuntos.length > 0) {
            noRecentActivity.style.display = 'none';

            // Mostrar las 3 transacciones más recientes
            const recentTransactions = historialPuntos.slice(0, 3);

            recentPoints.innerHTML = '';

            recentTransactions.forEach(tx => {
                const iconClass = tx.tipo === 'ACUMULACION' ? 'points-earned-icon' : 'points-redeemed-icon';
                const iconSymbol = tx.tipo === 'ACUMULACION' ? 'bi-plus-lg' : 'bi-dash-lg';
                const pointsClass = tx.tipo === 'ACUMULACION' ? 'points-positive' : 'points-negative';
                const pointsValue = tx.tipo === 'ACUMULACION' ? '+' + tx.cantidad : tx.cantidad;
                const itemClass = tx.tipo === 'ACUMULACION' ? 'points-earned' : 'points-redeemed';

                const itemHTML = `
                    <div class="list-group-item points-item ${itemClass}">
                        <div class="d-flex align-items-center">
                            <div class="points-icon ${iconClass}">
                                <i class="bi ${iconSymbol}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">${tx.motivo}</h6>
                                        <small class="text-muted">${formatDate(tx.fecha)}</small>
                                    </div>
                                    <div class="${pointsClass}">${pointsValue} pts</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                recentPoints.innerHTML += itemHTML;
            });
        } else {
            noRecentActivity.style.display = 'block';
        }

        // Actualizar historial completo de puntos
        const pointsHistoryBody = document.getElementById('pointsHistoryBody');

        if (historialPuntos && historialPuntos.length > 0) {
            pointsHistoryBody.innerHTML = '';

            historialPuntos.forEach(tx => {
                const pointsClass = tx.tipo === 'ACUMULACION' ? 'text-success' : 'text-danger';
                const pointsValue = tx.tipo === 'ACUMULACION' ? '+' + tx.cantidad : tx.cantidad;
                const tipoLabel = tx.tipo === 'ACUMULACION' ? 'Acumulación' : 'Canje';

                const rowHTML = `
                    <tr>
                        <td>${formatDate(tx.fecha)}</td>
                        <td><span class="badge ${tx.tipo === 'ACUMULACION' ? 'bg-success' : 'bg-danger'}">${tipoLabel}</span></td>
                        <td>${tx.motivo}</td>
                        <td class="${pointsClass}">${pointsValue} pts</td>
                    </tr>
                `;

                pointsHistoryBody.innerHTML += rowHTML;
            });
        } else {
            pointsHistoryBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">No hay transacciones de puntos registradas.</td>
                </tr>
            `;
        }

        // Actualizar sección de canjear puntos
        const rewardsContainer = document.getElementById('rewardsContainer');
        const noRewardsMessage = document.getElementById('noRewardsMessage');

        if (beneficiosDisponibles && beneficiosDisponibles.length > 0) {
            noRewardsMessage.style.display = 'none';

            rewardsContainer.innerHTML = '';

            // Array de imágenes de ejemplo para los beneficios
            const sampleImages = [
                'https://via.placeholder.com/400x200?text=Descuento+en+Comisiones',
                'https://via.placeholder.com/400x200?text=Tarjeta+de+Regalo',
                'https://via.placeholder.com/400x200?text=Cashback',
                'https://via.placeholder.com/400x200?text=Transferencia+sin+comisión'
            ];

            beneficiosDisponibles.forEach((beneficio, index) => {
                const availableClass = puntos && puntos.puntosAcumulados >= beneficio.costePuntos ?
                    'text-success' : 'text-danger';

                const availableText = puntos && puntos.puntosAcumulados >= beneficio.costePuntos ?
                    'Puntos suficientes' : 'Puntos insuficientes';

                const cardHTML = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card reward-card h-100" data-benefit-id="${beneficio.id}" onclick="selectBenefit('${beneficio.id}')">
                            <img src="${sampleImages[index % sampleImages.length]}" class="card-img-top" alt="${beneficio.nombre}">
                            <div class="reward-points">${beneficio.costePuntos} pts</div>
                            <div class="card-body">
                                <h5 class="card-title">${beneficio.nombre}</h5>
                                <p class="card-text">${beneficio.descripcion}</p>
                                <small class="${availableClass}">
                                    <i class="bi ${puntos && puntos.puntosAcumulados >= beneficio.costePuntos ? 'bi-check-circle-fill' : 'bi-x-circle-fill'}"></i>
                                    ${availableText}
                                </small>
                            </div>
                        </div>
                    </div>
                `;

                rewardsContainer.innerHTML += cardHTML;
            });
        } else {
            noRewardsMessage.style.display = 'block';
        }
    }

    // Función para seleccionar un beneficio para canjear
    function selectBenefit(benefitId) {
        // Buscar el beneficio seleccionado
        const selectedBenefit = beneficiosDisponibles.find(b => b.id === benefitId);

        if (selectedBenefit) {
            // Actualizar el modal con los detalles del beneficio
            document.getElementById('benefitName').textContent = selectedBenefit.nombre;
            document.getElementById('benefitDescription').textContent = selectedBenefit.descripcion;
            document.getElementById('benefitCost').textContent = selectedBenefit.costePuntos + ' pts';

            // Calcular los puntos restantes después del canje
            const puntosRestantes = (puntos ? puntos.puntosAcumulados : 0) - selectedBenefit.costePuntos;
            document.getElementById('remainingPoints').textContent = puntosRestantes + ' pts';

            // Verificar si hay puntos suficientes
            const redeemButton = document.getElementById('redeemButton');
            const confirmRedeem = document.getElementById('confirmRedeem');

            if (puntos && puntos.puntosAcumulados >= selectedBenefit.costePuntos) {
                redeemButton.disabled = !confirmRedeem.checked;
                confirmRedeem.disabled = false;
            } else {
                redeemButton.disabled = true;
                confirmRedeem.disabled = true;

                // Mostrar mensaje de puntos insuficientes
                alert('No tienes suficientes puntos para canjear este beneficio.');
            }

            // Mostrar el modal
            new bootstrap.Modal(document.getElementById('redeemModal')).show();
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar datos y UI con los datos reales del usuario
        loadUserData();

        // Event listener para el checkbox de confirmación de canje
        const confirmRedeem = document.getElementById('confirmRedeem');
        const redeemButton = document.getElementById('redeemButton');

        confirmRedeem.addEventListener('change', function() {
            redeemButton.disabled = !this.checked;
        });

        // Event listener para el botón de canje
        redeemButton.addEventListener('click', function() {
            showLoading();

            // Simular proceso de canje (en una aplicación real, este sería un llamado al backend)
            setTimeout(() => {
                hideLoading();

                // Ocultar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('redeemModal'));
                modal.hide();

                // Mostrar mensaje de éxito
                alert('¡Beneficio canjeado con éxito! Se ha descontado el monto correspondiente de tus puntos.');

                // Actualizar puntos disponibles (en una aplicación real, se recargarían desde el backend)
                const benefitCost = parseInt(document.getElementById('benefitCost').textContent);
                if (puntos) {
                    puntos.puntosAcumulados -= benefitCost;
                }

                // Recargar datos para reflejar el cambio
                loadUserData();
            }, 1000);
        });

        // Event listener para filtros de historial
        document.getElementById('typeFilter').addEventListener('change', filterHistory);
        document.getElementById('dateFromFilter').addEventListener('change', filterHistory);
        document.getElementById('dateToFilter').addEventListener('change', filterHistory);
        document.getElementById('pointsSearch').addEventListener('input', filterHistory);

        // Event listener para búsqueda de beneficios
        document.getElementById('rewardSearch').addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rewardCards = document.querySelectorAll('.reward-card');

            rewardCards.forEach(card => {
                const title = card.querySelector('.card-title').textContent.toLowerCase();
                const description = card.querySelector('.card-text').textContent.toLowerCase();

                if (title.includes(searchTerm) || description.includes(searchTerm)) {
                    card.closest('.col-md-6').style.display = '';
                } else {
                    card.closest('.col-md-6').style.display = 'none';
                }
            });
        });
    });

    // Función para filtrar el historial de puntos
    function filterHistory() {
        const typeFilter = document.getElementById('typeFilter').value;
        const dateFromFilter = document.getElementById('dateFromFilter').value ? new Date(document.getElementById('dateFromFilter').value) : null;
        const dateToFilter = document.getElementById('dateToFilter').value ? new Date(document.getElementById('dateToFilter').value) : null;
        const searchFilter = document.getElementById('pointsSearch').value.toLowerCase();

        const rows = document.getElementById('pointsHistoryBody').querySelectorAll('tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');

            // Si es la fila de "no hay transacciones", mostrarla siempre
            if (cells.length === 1 && cells[0].colSpan === 4) {
                return;
            }

            const date = new Date(cells[0].textContent);
            const type = cells[1].textContent.toLowerCase();
            const description = cells[2].textContent.toLowerCase();

            let show = true;

            // Filtrar por tipo
            if (typeFilter) {
                const isEarned = type.includes('acumulación');

                if (typeFilter === 'earned' && !isEarned) {
                    show = false;
                } else if (typeFilter === 'redeemed' && isEarned) {
                    show = false;
                }
            }

            // Filtrar por fecha de inicio
            if (show && dateFromFilter && date < dateFromFilter) {
                show = false;
            }

            // Filtrar por fecha de fin
            if (show && dateToFilter) {
                const toDateEnd = new Date(dateToFilter);
                toDateEnd.setHours(23, 59, 59, 999);

                if (date > toDateEnd) {
                    show = false;
                }
            }

            // Filtrar por término de búsqueda
            if (show && searchFilter) {
                if (!description.includes(searchFilter) && !type.includes(searchFilter)) {
                    show = false;
                }
            }

            row.style.display = show ? '' : 'none';
        });
    }
</script>
</body>
</html>